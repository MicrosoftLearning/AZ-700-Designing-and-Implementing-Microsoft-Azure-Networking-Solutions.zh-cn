---
Exercise:
  title: 模块 04 - 第 6 单元 使用 Azure 门户创建流量管理器配置文件
  module: Module 04 - Load balancing non-HTTP(S) traffic in Azure
---

# 模块 04-第 6 单元 使用 Azure 门户创建流量管理器配置文件

## 练习场景

在此练习中，你将创建一个流量管理器配置文件，以便为虚构的 Contoso Ltd 组织的 Web 应用程序提供高可用性。

   >**注意：** 我们提供 **[交互式实验室模拟](https://mslabs.cloudguides.com/guides/AZ-700%20Lab%20Simulation%20-%20Create%20a%20Traffic%20Manager%20profile%20using%20the%20Azure%20portal)** ，让你能以自己的节奏点击浏览实验室。 你可能会发现交互式模拟与托管实验室之间存在细微差异，但演示的核心概念和思想是相同的。

### 预计用时：35 分钟

你需要创建在两个不同的区域（“美国东部”和“西欧”）部署的两个 Web 应用程序实例。 “美国东部”区域将充当流量管理器的主终结点，“西欧”区域将充当故障转移终结点。

需根据终结点优先级创建流量管理器配置文件。 此配置文件将用户流量定向到运行 Web 应用程序的主站点。 流量管理器将持续监视 Web 应用程序，如果美国东部的主站点不可用，它将提供在西欧自动故障转移到备份站点的功能。

下图大致介绍了将在本练习中部署的环境。

 ![图片 14](../media/exercise-traffic-manager-environment-diagram.png)

 通过学习本练习，你将能够：

+ 任务 1：创建 Web 应用
+ 任务 2：创建流量管理器配置文件
+ 任务 3：添加流量管理器终结点
+ 任务 4：测试流量管理器配置文件

## 任务 1：创建 Web 应用

在本部分中，将创建部署在两个不同 Azure 区域中的 Web 应用程序的两个实例。

1. 在 Azure 门户主页上，单击“创建资源”，然后选择“Web 应用”（如果页面上未列出此资源类型，请使用页面顶部的搜索框搜索并选择该资源类型）。

1. 在“创建 Web 应用”页的“基本信息”选项卡上，使用下表中的信息创建第一个 Web 应用。

   | **设置**      | 值                                                    |
   | ---------------- | ------------------------------------------------------------ |
   | 订阅     | 选择订阅                                     |
   | 资源组   | 选择“新建”  名称：Contoso-RG-TM1             |
   | 名称             | **ContosoWebAppEastUSxx**（其中 xx 是你的姓名首字母，以确保名称独一无二） |
   | 发布          | **代码**                                                     |
   | 运行时堆栈    | **ASP.NET V4.8**                                             |
   | 操作系统 | **Windows**                                                  |
   | 区域           | **美国东部**                                                  |
   | Windows 计划     | 选择“新建”  名称：ContosoAppServicePlanEastUS |
   | 定价计划     | **标准 S1，总共 100 个 ACU，1.75-GB 内存**               |

1. 选择“监视”选项卡。

1. 在“监视”选项卡上，在“启用 Application Insights”中选择“否”选项。

1. 选择“查看 + 创建”。

   ![图片 18](../media/create-web-app-1.png)

1. 选择“创建”。 Web 应用在成功部署后会创建默认的网站。

1. 重复上述步骤 1-6，创建第二个 Web 应用。 除了下表中的信息以外，请使用与之前相同的设置。

   | **设置**    | **值**                                                    |
   | -------------- | ------------------------------------------------------------ |
   | 资源组 | 选择“新建”  名称：Contoso-RG-TM2             |
   | 名称           | **ContosoWebAppWestEuropexx**（其中 xx 是你的姓名首字母，以确保名称独一无二）  |
   | 区域         | “西欧”                                              |
   | Windows 计划   | 选择“新建”  名称：ContosoAppServicePlanWestEurope |

1. 在 Azure 主页上，选择“所有服务”，在左侧导航菜单中，选择“Web”，然后选择“应用服务”。

1. 你应会看到列出的两个新 Web 应用。

   ![图片 19](../media/create-web-app-2.png)

## 任务 2：创建流量管理器配置文件

现在将创建流量管理器配置文件，以根据终结点优先级定向用户流量。

1. 在 Azure 门户主页上，选择“创建资源”。

1. 在页面顶部的“搜索”框中，输入“流量管理器配置文件”，然后从弹出列表中选择该配置文件。

   ![图片 20](../media/create-tmprofile-1.png)

1. 选择“创建”。

1. 在“创建流量管理器配置文件”页上，使用下表中的信息创建流量管理器配置文件。

   | **设置**             | **值**                |
   | ----------------------- | ------------------------ |
   | 名称                    | **Contoso-TMProfilexx**（其中 xx 是你的姓名首字母，以确保名称独一无二） |
   | 路由方法          | **Priority**             |
   | 订阅            | 选择订阅 |
   | 资源组          | Contoso-RG-TM1       |
   | 资源组位置 | **美国东部**              |

1. 选择“创建”。

## 任务 3：添加流量管理器终结点

在本部分中，你将在美国东部添加网站作为主终结点，以路由所有用户流量。 然后，在西欧添加网站作为故障转移终结点。 如果主终结点不可用，流量将自动路由到故障转移终结点。

1. 在 Azure 门户主页上，选择“所有资源”，然后在资源列表中选择“Contoso-TMProfile”。

1. 在“设置”下，选择“终结点”，然后选择“添加”。

   ![图片 21](../media/create-tmendpoints-1.png)

1. 在“添加终结点”页上，输入下表中的信息。

   | **设置**          | **值**                         |
   | -------------------- | --------------------------------- |
   | 类型                 | **Azure 终结点**                |
   | 名称                 | **myPrimaryEndpoint**             |
   | 目标资源类型 | **应用服务**                   |
   | 目标资源      | ContosoWebAppEastUS（美国东部） |
   | 优先度             | **1**                             |

1. 选择 **添加** 。

1. 重复上述步骤 2-4 以创建故障转移终结点。 除了下表中的信息以外，请使用与之前相同的设置。

   | **设置**     | **值**                                 |
   | --------------- | ----------------------------------------- |
   | 名称            | myFailoverEndpoint                    |
   | 目标资源 | ContosoWebAppWestEurope（西欧） |
   | 优先度        | **2**                                     |

1. 如果将优先级设置为 2，则意味着在配置的主终结点变得不正常时，流量将路由到此故障转移终结点。

1. 在“设置”下，选择“配置”，然后将终结点监视器设置“协议”更新为 HTTPS，将“端口”更新为 443，然后选择“保存”    。

1. 这两个新终结点显示在流量管理器配置文件中。 请注意，几分钟后，“监视状态”应更改为“联机”。

   ![图片 22](../media/create-tmendpoints-2.png)

## 任务 4：测试流量管理器配置文件

在本部分中，你将检查流量管理器配置文件的 DNS 名称，然后将主终结点配置为不可用。 然后，将验证 Web 应用是否仍可用，以测试流量管理器配置文件是否已成功将流量发送到故障转移终结点。

1. 在“Contoso-TMProfile”页上，选择“概述”。

1. 在“概述”屏幕上，将“DNS 名称”条目复制到剪贴板（或记到某个位置）。

   ![图片 23](../media/check-dnsname-1.png)

1. 打开 Web 浏览器标签页，在地址栏中粘贴（或输入）DNS 名称条目 (contoso-tmprofile.trafficmanager.net)，然后按 Enter。

1. 应显示 Web 应用的默认网站。 如果收到“404 找不到网站”消息，请先从“Contoso-TMProfilexx”流量管理器配置文件概览页面“禁用配置文件”，再“启用配置文件”   。 然后刷新网页。

   ![图片 24](../media/tm-webapp-test-1a.png)

1. 当前正在将所有流量发送到主终结点，因为已将其“优先级”设置为 1。

1. 若要测试故障转移终结点是否正常工作，需要禁用主站点。

1. 在“Contoso-TMProfile”页上，在“概述”屏幕上选择“myPrimaryEndpoint”。

1. 在“myPrimaryEndpoint”页的“状态”下，选择“已禁用”，然后选择“保存”。

   ![图 25](../media/disable-primary-endpoint-1.png)

1. 关闭“myPrimaryEndpoint”页（选择页面右上角的“X”）。

1. 在“Contoso-TMProfile”页上，“myPrimaryEndpoint”的“监视器状态”现在应为“已禁用”。

1. 打开新的 Web 浏览器会话，在地址栏中粘贴（或输入）DNS 名称条目 (contoso-tmprofile.trafficmanager.net)，然后按 Enter。

1. 验证 Web 应用是否仍可响应。 由于主终结点不可用，因此流量被路由到故障转移终结点，以允许网站仍可正常工作。

## 清理资源

   >**注意**：记得删除所有不再使用的新建 Azure 资源。 删除未使用的资源可确保不会出现意外费用。

1. 在 Azure 门户的“Cloud Shell”窗格中打开“PowerShell”会话 。

1. 通过运行以下命令，删除在此模块的实验室中创建的所有资源组：

   ```powershell

   Remove-AzResourceGroup -Name 'Contoso-RG-TM1' -Force -AsJob
   Remove-AzResourceGroup -Name 'Contoso-RG-TM2' -Force -AsJob

   ```

   >**注意**：该命令以异步方式执行（由 -AsJob 参数决定），因此，虽然你可以随后立即在同一个 PowerShell 会话中运行另一个 PowerShell 命令，但需要几分钟才能实际删除资源组。

## 使用 Copilot 扩展学习

Copilot 可帮助你了解如何使用 Azure 脚本工具。 Copilot 还可以帮助了解实验室中未涵盖的领域或需要更多信息的领域。 打开 Edge 浏览器并选择“Copilot”（右上角）或导航到*copilot.microsoft.com*。 花几分钟时间尝试这些提示。
+ 配置 Azure 流量管理器的大致步骤是什么？
+ 比较和对比何时使用 Azure 负载均衡器和 Azure 流量管理器。
+ 说明流量管理器路由配置文件以及何时应使用这些配置文件。

## 通过自定进度的培训了解详细信息

+ [使用 Azure 流量管理器增强服务可用性和数据定位](https://learn.microsoft.com/training/modules/distribute-load-with-traffic-manager/) 在本模块中，你将了解如何使用流量管理器动态分配网络流量。
+ [在 Azure 中对非 HTTP(S) 流量进行负载均衡](https://learn.microsoft.com/training/modules/load-balancing-non-https-traffic-azure/)。 在本模块中，你将了解 Azure 流量管理器并实现路由方法。 

## 关键结论

恭喜你完成本实验室的内容。 下面是本实验室的主要重点。 
+ Azure 流量管理器是基于 DNS 的流量负载均衡器。 此服务让你可以在全球 Azure 区域将流量分布到面向公众的应用程序。
+ 流量管理器包含六种流量路由方法，可用于控制流量管理器如何选择具体的终结点来从每个最终用户处接收流量。 你能说出几个？
+ 可以嵌套流量管理器配置文件，将多个流量路由方法的优势结合在一起。 使用嵌套式配置文件可以重写默认的流量管理器行为，支持更大、更复杂的应用程序部署。
